// demo/test_cap.9

extern fn printf(fmt: ^u8, ...) -> i32;

// 定义泛型接口
cap Converter#<Target> {
    fn convert(self) -> Target;
}

// 泛型结构体
struct IntWrapper { val: i32; }

// 实现泛型接口 (将 IntWrapper 转换为 f64)
imp Converter#<f64> for IntWrapper {
    fn convert(self) -> f64 {
        ret self.val as f64; 
    }
}

// 泛型函数：依赖约束 T: Converter<f64>
fn process#<T: Converter#<f64>>(item: T) {
    // 这里发生了 Abstract Dispatch -> 实际调用了 IntWrapper::convert
    set f: f64 = item.convert();
    printf("Converted value: %f\n", f);
}

fn main() -> i32 {
    printf("--- Cap Test Start ---\n");
    
    set w: IntWrapper = IntWrapper { val: 100 };
    
    // 调用泛型函数，触发单态化
    // process_IntWrapper 被生成
    process#<IntWrapper>(w);
    
    printf("--- Cap Test Passed ---\n");
    ret 0;
}